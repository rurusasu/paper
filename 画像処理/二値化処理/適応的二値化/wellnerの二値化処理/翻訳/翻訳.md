# Introduction
白い紙に黒く印刷されたものをビデオカメラで撮影しても、本当の意味での白黒ではない。カメラがどこを向いていてもグレースケール（またはカラー）なのだ。机の上の照明をうまくコントロールしないと、机の上に置かれた紙をビデオで撮影しても、実際の紙のイメージとはかけ離れたものになってしまう。スキャナーやコピー機の内部とは異なり、机の上では均一な照明を確保することが非常に難しい。机の上には、デスクランプや間接照明、窓、動く影などがあり、それらの影響でページ全体の明るさが変わってしまうことがあります。人間の視覚はこれを補正しますが、机の上の紙のイメージがこれらの変化を考慮せずに機械で操作されると、非常に悪い結果になります。例えば、図5-1では、右側の「in case of emergency」のボックスの背景が周囲の背景と一致せず、はっきりとした縁が残っています。右側のボックスには周囲の背景が表示されています。左から右に向かって濃くなっているのは、紙の左側に光が当たっていたために 左から右に向かって暗くなっているのは、この画像を取り込んだ紙の左側に光が当たっていたからです。

この問題は、コントラストの高い線画やテキストを扱うときに顕著に現れます。なぜなら、元の原稿は純粋な白黒であるにもかかわらず、カメラはさまざまなレベルのグレーの画像を生成するからです。DigitalDeskで試作された多くのアプリケーションは、線画を投影するために、画像のどの部分が黒か白かを明確に判断しなければなりません。線画を机の上に投影したり、テキスト画像を光学式文字認識（OCD）に渡したりするために これは、線画を机の上に投影したり、テキスト画像を光学式文字認識（OCR）サーバーに渡したりするためです。このシステムでは グレーの画像（通常は1ピクセルあたり8ビット）はシステムで使用できないため、白黒の画像（1ピクセルあたり1ビット）に変換する必要があります。これにはさまざまな方法があります。場合によっては、人が見ることを想定して、できるだけグレースケールの画像のように見えるように、ディザ やハーフトーン（[Floy76]のような手法）を用いて、以下のような結果を得ることができます。図5-1。この画像はグレースケール画像のように見えますが、黒と白の小さな斑点が様々な形で存在しています。この画像はグレースケール画像のように見えますが、様々なパターン、密度、サイズの小さな黒と白の斑点で構成されています。人間の視覚は、これらの画像をグレー画像や元の白黒画像とほぼ同じように理解します。しかし、文字認識や選択・貼り付け、複数の画像の合成などの機械処理では、ディザやハーフトーンの画像を使うことはできません。これらの画像は、1画素に1ビットしかないにもかかわらず、本来のグレースケール画像よりも機械処理に適していません。そのため、単純なパターンの線や文字、比較的大きな白と黒のパッチが必要となります。グレー画像からこれらのタイプの白黒画像を生成するプロセスは、一般的に「閾値処理」と呼ばれており、デジタルデスクシステムの重要な要件となっています。

画像の閾値処理には様々な方法がありますが、基本的なプロセスは、各グレーピクセルを検査し、それを黒にするか白にするかを決定することです。本レポートでは、DigitalDesk での閾値処理のために開発・テストされた様々な技術について説明し、最後に適切と思われるアルゴリズムについて説明しています。このアルゴリズム（ここでは "Quick Adaptive Thresholding "と呼びます）は、最良のものではないかもしれませんが、十分に機能しますので、ここで紹介した段階では、DigitalDeskの他の問題の方が重要になりました。

# Global Thresholding
ある意味では、閾値処理はコントラスト強調の極端な形、つまり明るいピクセルをより明るく、暗いピクセルをより暗くすることと捉えることができます。画像を閾値処理する最も簡単な（そして最も一般的な）方法は、あるグレーレベル以下のすべてのピクセルを黒に設定し、それ以外のピクセルを白にすることです。問題は、このグレーレベルをどのように選択するかです。例えば、ピクセルが8ビット（0〜255）であれば、128が選択されることになります。この方法は、画像のすべての「暗い」ピクセルが128以下の値を持ち、明るいピクセルが128以上の値を持つ場合には有効ですが、画像の露出が過剰または不足している場合には、結果としてすべてが白または黒になってしまいます。閾値を決める際には、可能性のある値ではなく、実際の値の範囲を見たほうがよいでしょう。画像の各ピクセルの最大値と最小値を求め、その中間値をしきい値とすることができます。さらに良い方法は、実際の値の範囲だけでなく、その分布を見てしきい値を決めることです。例えば、白地に黒の線画や文字が描かれている画像の場合、ほとんどのピクセルは背景の濃さになり、小さいながらも濃いインクの割合が多くなると考えられます。画素の強度のヒストグラムは、図5-2のようになります。

背景の大きなピークと、ダークインクの小さなピークが見えるはずです。周囲の明るさによっては、曲線全体が左右にずれることもありますが、いずれにしても、2つのピークの間の局所的な最小値を閾値として選ぶのが最適です。理論的には問題ありませんが、実際にはどのように機能するのでしょうか。図5-3は、この手法が有効なフレームグラブ画像とそのヒストグラムです。平滑化されたヒストグラムには2つの顕著なピークがあり、このヒストグラムに曲線を当てはめたり、2つのピークの中間点を取ったりして、理想に近いしきい値を計算することは難しくありません。しかし、この画像は白と黒の両方が多く含まれており、典型的な画像ではありません。DigitalDeskでは、図5-4のような画像の閾値も設定できなければなりません。この画像のヒストグラムでは、小さい「暗い」ピークがノイズに紛れてしまっているため、ピーク間の局所的な最小値を確実に見つけることができません。そのため、画像を閾値処理する際には、次のような戦略が有効です。

1. ヒストグラムを算出する（図5-4の点で示す）。
1. ヒストグラム曲線の移動平均の最大値を求めることで、大きなピークを見つけることができます。移動平均は、図5-3と図5-4の曲線のように、最大値に対するノイズの影響を滑らかにします。
1. このピークと最小値の間の距離に一定の割合でしきい値を選択します。このピークと最小値（ゼロカウントを除く）の間の距離の一定割合で閾値を選択します。

実験によると、この距離の1/2であれば、非常に明るい場所からほとんど真っ暗な場所まで、幅広い照明条件で非常に良い結果が得られるようです。例えば、図5-4では、ピークが215で、最も低い記録値が75なので、しきい値は145になります。次の図（図5-5）は、4つの異なる照明条件で撮影した画像に、このヒストグラム・グローバル・スレッショルド・アルゴリズムを適用した結果を示しています。ヒストグラムからわかるように、さまざまな照明条件にもかかわらず、このアルゴリズムはそれぞれのケースで適切なしきい値を選択しており、それぞれのしきい値の結果はほぼ同じになっています。

このヒストグラムベースのグローバル閾値処理技術は、光が均一に当たっている画像や、上の例のように、光があまり変化しない紙のごく小さな部分を表す画像では、非常にうまく機能します。しかし、より広い領域や、机の上で明るさの範囲が大きく異なる通常のオフィスの照明下では、良い結果を得ることができません。また、画像全体に単一のグローバルしきい値を使用するため、画像の一部が白すぎたり、暗すぎたりします。その結果、図5-6のように、テキストの多くが読めなくなります。

不均一に光っている紙から良好なしきい値画像を生成するには、適応型しきい値アルゴリズムが必要です。この技術は、各ピクセルの背景の照度に応じて、画像全体のしきい値を変化させるものです。以下では 以下では、図5-6の画像に適用したアルゴリズムの結果を説明します。この画像は横から照明されており、白地に黒の文字（「PaperWorks」）、黒地に白の文字（「XEROX」）、白地に灰色の文字（「The best way...」）、さまざまな影、「PaperWorks」の文字の下に細い水平の黒線があるため、難易度の高いテストとなっています。PaperWorks "の文字の下に細い水平の黒い線があります。

# Adaptive Thresholding
理想的な適応閾値アルゴリズムは、照明にムラのあるページに適用した場合、グローバル閾値アルゴリズムが完全に均等に照明されたページに適用した場合と同じ結果を生むでしょう。各ピクセルの明るさは、照明の多寡を補正するために正規化され、その結果初めて、黒か白かの判断がなされるのです。そこで問題となるのが、各点における背景の照度をどのように決定するかです。簡単な方法としては、閾値処理するページを取り込む前に、白紙のページを取り込むことです。この白紙のページを参照画像として使用することができます。閾値を設定する各画素について、基準画像の対応する画素の値を減算してから閾値を適用します。

この方法は、基準画像と被写体画像をそれぞれ撮影する間に照明が変化しない限り、非常に良い結果を得ることができます。しかし、机の上では、ユーザーの影が机の上を移動したり、ドアやランプなどが移動したりすることで、照明が頻繁に変化する。また、部屋に窓があれば、一日のうちでも照明が変化します。しかし、スキャナーを使うのと同じように不便で、オーバーヘッドビデオカメラを使う重要な理由が失われてしまいます。

もう一つの解決策は、画像の見え方をある程度仮定して、各ピクセルにおける背景の照度を推定してみることである。例えば、画像のほとんどが背景（例えば白）であり、暗いマークは画像のごく一部を構成していると仮定することができます。また、ページ上のマークによる明暗の変化に比べて、背景の明るさの変化はページ全体で比較的ゆっくりであるという仮定も可能です。このような仮定に基づく多くのアルゴリズムが可能である。適応的閾値処理には数学的理論がなく、その結果、それを行うための標準的・最適な方法も存在しない [Prat91] (p. 597)。その代わりに、いくつかのアドホックな方法があり、そのうちのいくつかは他よりも人気があります。これらの方法はアドホックであるため、その性能を測定することができれば便利である。このため、Haralick and Shapiro [Hara85]は、領域はグレートーンに関して均一かつ均質であること、領域内部は単純で多くの小さな穴がないこと、隣接領域は著しく異なる値を持つこと、各セグメントの境界は単純でぼろくなく、空間的に正確でなければならないというガイドラインを提案する。

Pratt氏によると、画像の閾値処理について定量的な性能指標は開発されていない。アルゴリズムを評価する主な方法は、単純に結果を見て、それが正しく見えるかどうかを判断することであるようだ。テキストの画像であれば、定量的な可能性があります。様々な照明条件下での様々なアルゴリズムの結果をOCRシステムに与え、そこから生成されるテキストを元のテキストと比較することができる。この方法は有用である可能性がありますが、「見た目が良い」という基準とは異なる評価を与える可能性が低いと判断されたため、以下に述べるアルゴリズムでは体系的に使用されていません。

DigitalDeskの対話型アプリケーションでは、テキストやグラフィックの「コピー＆ペースト」などの対話技術を完了する際、ユーザーは閾値処理が終了するのを待つ必要があります。そのため、もう1つの重要な定量的性能評価指標は速度です。以下のセクションでは、さまざまな適応的閾値処理アルゴリズムについて説明し、それらがもたらす結果を示しています。

# Adaptive thresholding based on Wall’s algorithm
背景の明るさに応じて画像全体で変化する閾値を計算する手法の1つが、R. J. Wallによって開発され、[Cast79]に記述されています。以下のアルゴリズムは、この記述に大まかに基づいている。まず、画像を小さなタイルに分割し、各タイルについてヒストグラムを計算します。これらのヒストグラムのピークに基づいて、各タイルに閾値が選択されます。次に、画像内の各点に、各タイルで選択された値の間を補間することにより、閾値を割り当てます。図 5-7 は，同じグレーのタイル（3x3）から生成され，各タイルについて，ピークから 20％下の閾値が選択された。この値から、9枚のタイルのそれぞれの中心に角を持つ16枚のタイルを形成し、その角から各タイルに渡って閾値を補間している。グローバル閾値よりもはるかに良い結果が得られるが、画像を複数回通過させる必要があるため、かなり時間がかかる。また、この手法の問題点として、画像によっては黒や白が多いとローカルヒストグラムが騙され、閾値が画像全体で滑らかに変化せず、結果が非常に悪くなることがあります（図5-8を参照）。
